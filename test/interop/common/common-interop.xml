<?xml version="1.0"?>

<project name="common-interop">

    <property name="src.dir" value="src" />
    <property name="build.dir" value="build" />
    <property name="idl.dir" value="idl" />
    <property name="classes.dir" value="${build.dir}/classes" />
    <property name="gen.dir" value="${build.dir}/generated" />
    <property name="jacorb.dir" value="../../.." />
    <property name="jacorb.lib" value="${jacorb.dir}/lib" />

    <path id="jacorb.classpath">
        <pathelement location="${jacorb.dir}/classes" />
        <fileset dir="${jacorb.lib}">
            <include name="*.jar" />
        </fileset>
    </path>

    <path id="interop.classpath">
        <pathelement location="${classes.dir}" />
        <pathelement location="${resources.dir}" />
    </path>

    <!-- properties for LynxOS and PPC card -->
    <condition property="os-name-lynx">
		<equals arg1="${os.name}"
			arg2="LynxOS"
			casesensitive="false"
			trim="true"
		/>
	</condition>
	<condition property="tiny-lynx-arch">
        <and>
            <istrue value="${os-name-lynx}" />
            <equals arg1="${os.arch}"
                    arg2="ppc"
                    casesensitive="false"
                    trim="true"
            />
        </and>
    </condition>

        <!-- This property is used collectively to identify a tiny system -->
        <!-- architectures.  It is used to minimize ant's actions so that  -->
        <!-- tests and some demos can be executed on a tiny system with very   -->
        <!-- little memory.  Quynh N. -->
    <condition property="tiny-system-arch">
        <or>
            <istrue value="${tiny-lynx-arch}" />
            <!-- remove entry below if another property is added -->
            <istrue value="${tiny-lynx-arch}" />
        </or>
    </condition>

    <taskdef name="jacorbidl" classname="org.jacorb.idl.JacIDL" classpathref="jacorb.classpath" />

    <target name="tiny-system-check"  >
      <fail message="Task is not allowed on ${os.name}/${os.arch} system."
         if="tiny-system-arch" >
      </fail>
    </target>

    <target name="idl" >
        <jacorbidl srcdir="${idl.dir}"
                   destdir="${gen.dir}"
                   includes="*.idl"
                   helpercompat="jacorb"
                   includepath="${jacorb.dir}/idl/omg" />
    </target>

    <target name="compile" depends="tiny-system-check,idl" >
        <mkdir dir="${classes.dir}" />

        <javac destdir="${classes.dir}" debug="true" includeAntRuntime="false">
            <src path="${src.dir}" />
            <src path="${gen.dir}" />
            <classpath refid="jacorb.classpath" />
        </javac>
    </target>

    <target name="clean" >
        <delete dir="${build.dir}" />
    </target>

    <macrodef name="run-java" taskname="java">
        <attribute name="classname" />
        <attribute name="argline" default="" />

        <sequential>
            <java classname="@{classname}" fork="true">
                <jvmarg value="-Xbootclasspath/p:${jacorb.dir}/classes" />
                <jvmarg value="-Djava.endorsed.dirs=${jacorb.lib}" />
                <jvmarg value="-Dorg.omg.CORBA.ORBClass=org.jacorb.orb.ORB" />
                <jvmarg value="-Dorg.omg.CORBA.ORBSingletonClass=org.jacorb.orb.ORBSingleton" />
                <classpath refid="interop.classpath" />
                <arg line="@{argline}" />
            </java>
        </sequential>
    </macrodef>

</project>
